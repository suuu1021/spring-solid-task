<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SolidTask Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
            max-width: 600px;
            margin: auto;
            padding: 20px;
        }
        #chat-window {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            word-wrap: break-word;
        }
        .message {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }
        .message .sender {
            font-weight: bold;
            color: #0066cc;
        }
        .status {
            color: green;
            font-weight: bold;
            margin: 10px 0;
        }
        .error {
            color: red;
        }
        input[type="text"] {
            padding: 5px;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        button {
            padding: 5px 10px;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        button:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #e0e0e0;
        }
    </style>
</head>
<body>
<h2>SolidTask 실시간 이슈 채팅</h2>
<div>
    <input type="text" id="issueId" placeholder="참여할 이슈 ID"/>
    <input type="text" id="sender" placeholder="사용자 이름"/>
    <button id="connectBtn" onclick="connect()">연결</button>
    <button id="disconnectBtn" onclick="disconnect()" disabled>연결 끊기</button>
</div>
<div id="status" class="status"></div>
<hr/>
<div id="chat-window"></div>
<div>
    <input type="text" id="message" placeholder="메시지 입력..." style="width: 70%" onkeypress="if(event.key==='Enter') sendMessage()"/>
    <button id="sendBtn" onclick="sendMessage()" disabled>전송</button>
</div>

<script>
    var stompClient = null;
    var currentIssueId = null;

    function connect() {
        var issueId = document.getElementById('issueId').value.trim();
        var sender = document.getElementById('sender').value.trim();

        if (!issueId || !sender) {
            alert("이슈 ID와 사용자 이름을 입력하세요.");
            return;
        }

        // 연결 중 상태 표시
        setStatus("연결 중...", false);

        // 1. SockJS를 사용하여 WebSocket 엔드포인트(/ws-stomp)에 연결합니다.
        var socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);

        // 2. STOMP 프로토콜로 서버에 연결합니다.
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            currentIssueId = issueId;

            // UI 상태 업데이트
            setStatus("이슈 " + issueId + "에 연결됨 (" + sender + ")", true);
            updateButtons(true);

            // 3. 연결 성공 시, 특정 이슈의 토픽('/topic/issues/{issueId}')을 구독합니다.
            stompClient.subscribe('/topic/issues/' + issueId, function (chatMessage) {
                showMessage(JSON.parse(chatMessage.body));
            });

        }, function(error) {
            // 연결 실패 처리
            console.log('Connection failed: ' + error);
            setStatus("연결 실패: " + error, false, true);
            updateButtons(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
            stompClient = null;
            currentIssueId = null;
        }
        setStatus("연결 끊김", false);
        updateButtons(false);
        console.log("Disconnected");
    }

    function sendMessage() {
        // 연결 상태 체크
        if (stompClient === null || !currentIssueId) {
            alert("먼저 연결해주세요!");
            return;
        }

        var sender = document.getElementById('sender').value.trim();
        var content = document.getElementById('message').value.trim();

        if (!content) {
            alert("메시지를 입력하세요!");
            return;
        }

        // 4. 메시지를 @MessageMapping이 설정된 경로('/app/chat/{issueId}')로 전송합니다.
        stompClient.send("/app/chat/" + currentIssueId, {}, JSON.stringify({
            'issueId': currentIssueId,
            'sender': sender,
            'content': content
        }));

        document.getElementById('message').value = '';
    }

    function showMessage(message) {
        var chatWindow = document.getElementById('chat-window');
        var p = document.createElement('p');
        p.className = 'message';

        // 현재 시간 추가
        var now = new Date();
        var timeStr = String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0');

        p.innerHTML = '<span class="sender">' + escapeHtml(message.sender) +
            '</span> [' + timeStr + ']: ' + escapeHtml(message.content);

        chatWindow.appendChild(p);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // 상태 표시 함수
    function setStatus(message, isConnected, isError) {
        var statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        if (isError) {
            statusDiv.className = 'error';
        } else if (isConnected) {
            statusDiv.className = 'status';
        } else {
            statusDiv.className = '';
        }
    }

    // 버튼 상태 관리 함수
    function updateButtons(isConnected) {
        document.getElementById('connectBtn').disabled = isConnected;
        document.getElementById('disconnectBtn').disabled = !isConnected;
        document.getElementById('sendBtn').disabled = !isConnected;
    }

    // XSS 방지를 위한 HTML 이스케이프 함수
    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    // 페이지 로드 시 초기화
    window.onload = function() {
        console.log('SolidTask 채팅 페이지가 로드되었습니다.');
        setStatus("연결되지 않음", false);
    };

    // 페이지 종료 시 연결 해제
    window.onbeforeunload = function() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    };
</script>
</body>
</html>
